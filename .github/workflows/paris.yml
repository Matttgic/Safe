name: Paris UltraSafe

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

jobs:
  generer_paris:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: pip install requests pandas
    
    - name: Convert match format
      run: |
        python3 -c """
import json
with open('donnees/matchs_du_jour.json', 'r') as f:
    data = json.load(f)
if 'fixtures' in data:
    matchs = [{'team_a_id': f['home_team']['id'], 'team_b_id': f['away_team']['id']} 
              for f in data['fixtures']]
    with open('donnees/matchs_du_jour.json', 'w') as f:
        json.dump({'matchs': matchs}, f)
"""
    
    - name: Generate predictions
      run: |
        python3 scripts/moteur_paris_ultrasafe.py \
          --stats-file donnees/stats_equipes_2025.jsonl \
          --fallback-stats donnees/stats_equipes_2024.jsonl \
          --matchs-file donnees/matchs_du_jour.json \
          --output donnees/paris_du_jour.csv \
          --historique donnees/historique.csv
    
    - name: Commit results
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ðŸŽ° Paris du $(date +%Y-%m-%d)"
        file_pattern: "donnees/*.csv"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: paris-results
        path: donnees/*.csv
