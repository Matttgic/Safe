name: GÃ©nÃ©rer Paris du Jour UltraSafe

on:
  workflow_dispatch:
    inputs:
      matchs_source:
        description: "Source des matchs (existing/test/api)"
        required: true
        default: "existing"
        type: choice
        options:
          - existing
          - test
          - api
      seuils_custom:
        description: "Seuils custom en JSON (optionnel)"
        required: false
        type: string
      debug_mode:
        description: "Mode debug verbose"
        required: false
        default: false
        type: boolean
  schedule:
    # ExÃ©cution automatique chaque jour Ã  8h UTC
    - cron: '0 8 * * *'

jobs:
  generer_paris:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Installer les dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas jq

      - name: 1. VÃ©rifier les prÃ©requis (fichiers de stats)
        id: check_stats
        run: |
          echo "ğŸ” VÃ©rification des fichiers de statistiques..."
          stats_file=""
          if [ -f "donnees/stats_equipes_2025.jsonl" ]; then
            stats_file="donnees/stats_equipes_2025.jsonl"
            echo "âœ… Utilisation du fichier de stats 2025."
          elif [ -f "donnees/stats_equipes_2024.jsonl" ]; then
            stats_file="donnees/stats_equipes_2024.jsonl"
            echo "âš ï¸ Fichier 2025 non trouvÃ©, utilisation du fallback 2024."
          else
            echo "âŒ Aucun fichier de statistiques trouvÃ© (stats_equipes_2025.jsonl ou _2024.jsonl)."
            echo "ğŸ’¡ ExÃ©cutez d'abord le workflow 'GÃ©nÃ©rer Stats Ã‰quipes'."
            exit 1
          fi
          # Exporter la variable pour les Ã©tapes suivantes
          echo "stats_file_path=$stats_file" >> $GITHUB_ENV

      - name: 2. PrÃ©parer la source des matchs
        run: |
          # DÃ©terminer la source des matchs
          if [ "${{ github.event_name }}" == "schedule" ]; then
            matchs_source="existing"  # Par dÃ©faut utiliser le fichier existant
          else
            matchs_source="${{ github.event.inputs.matchs_source }}"
          fi
          echo "ğŸ¯ Source des matchs sÃ©lectionnÃ©e : $matchs_source"
          echo "MATCHS_SOURCE=$matchs_source" >> $GITHUB_ENV

          # CrÃ©er le rÃ©pertoire si nÃ©cessaire
          mkdir -p donnees

          if [ "$matchs_source" == "existing" ]; then
            echo "ğŸ“ Utilisation du fichier de matchs existant..."
            if [ -f "donnees/matchs_du_jour.json" ]; then
              # VÃ©rifier que le fichier contient des donnÃ©es
              match_count=$(python3 -c "
import json
try:
    with open('donnees/matchs_du_jour.json', 'r') as f:
        data = json.load(f)
    count = data.get('count', len(data.get('fixtures', data.get('matchs', []))))
    print(count)
except:
    print(0)
")
              if [ "$match_count" -gt 0 ]; then
                echo "âœ… Fichier existant trouvÃ© avec $match_count matchs"
              else
                echo "âš ï¸ Fichier existant vide, passage en mode test"
                matchs_source="test"
              fi
            else
              echo "âš ï¸ Fichier matchs_du_jour.json non trouvÃ©, passage en mode test"
              matchs_source="test"
            fi
          fi

          if [ "$matchs_source" == "test" ]; then
            echo "ğŸ§ª CrÃ©ation du fichier de matchs de test..."
            # CrÃ©ation d'un fichier JSON de test simple et valide
            echo '{
              "source": "test",
              "matchs": [
                {"team_a_id": 50, "team_b_id": 42, "commentaire": "Man City vs Arsenal"},
                {"team_a_id": 40, "team_b_id": 49, "commentaire": "Liverpool vs Chelsea"},
                {"team_a_id": 529, "team_b_id": 541, "commentaire": "Barcelona vs Real Madrid"}
              ]
            }' > donnees/matchs_du_jour.json
            echo "âœ… Fichier de matchs de test crÃ©Ã©."
          elif [ "$matchs_source" == "api" ]; then
            echo "ğŸŒ RÃ©cupÃ©ration des matchs via l'API..."
            # Simule l'appel Ã  un script de rÃ©cupÃ©ration. Remplacez par votre vrai script.
            # python3 scripts/recuperer_matchs_jour.py --out donnees/matchs_du_jour.json
            echo "âš ï¸ Logique de rÃ©cupÃ©ration API Ã  implÃ©menter. Utilisation d'un fichier test en fallback."
            echo '{
              "source": "api-fallback",
              "matchs": [
                {"team_a_id": 157, "team_b_id": 165, "commentaire": "Bayern vs Dortmund"}
              ]
            }' > donnees/matchs_du_jour.json
          fi

          # Mise Ã  jour de la variable d'environnement avec la source finale
          echo "MATCHS_SOURCE_FINAL=$matchs_source" >> $GITHUB_ENV

      - name: 3. CrÃ©er les seuils custom (si fournis)
        if: github.event.inputs.seuils_custom != ''
        run: |
          echo "ğŸ›ï¸ CrÃ©ation du fichier de seuils custom..."
          echo '${{ github.event.inputs.seuils_custom }}' > donnees/seuils_custom.json
          echo "âœ… Fichier de seuils custom crÃ©Ã©."

      - name: 4. ExÃ©cuter le moteur UltraSafe
        id: run_engine
        run: |
          echo "ğŸš€ Lancement du moteur de paris UltraSafe..."
          # Construction des arguments pour le script
          args="--stats-file ${{ env.stats_file_path }}"
          args="$args --matchs-file donnees/matchs_du_jour.json"
          args="$args --output donnees/paris_du_jour.csv"
          args="$args --historique donnees/historique.csv"

          # Ajout des seuils custom s'ils existent
          if [ -f "donnees/seuils_custom.json" ]; then
            args="$args --seuils donnees/seuils_custom.json"
            echo "Inclusion des seuils custom."
          fi

          # Ajout du mode debug si activÃ©
          if [ "${{ github.event.inputs.debug_mode }}" == "true" ]; then
            args="$args --debug"
            echo "ğŸ› Mode debug activÃ©."
          fi

          echo "Commande: python3 scripts/moteur_paris_ultrasafe.py $args"
          python3 scripts/moteur_paris_ultrasafe.py $args

      - name: 5. Analyser et afficher les rÃ©sultats
        if: always() && steps.run_engine.outcome == 'success'
        run: |
          echo "ğŸ“Š Analyse des rÃ©sultats..."
          if [ -f "donnees/paris_du_jour.csv" ]; then
            echo "âœ… Fichier 'paris_du_jour.csv' gÃ©nÃ©rÃ©."
            
            # Compter les lignes de paris (en excluant l'en-tÃªte)
            paris_count=$(tail -n +2 donnees/paris_du_jour.csv | wc -l)
            echo "ğŸ“ˆ Nombre de paris gÃ©nÃ©rÃ©s : $paris_count"
            
            if [ "$paris_count" -gt 0 ]; then
              echo "ğŸ“‹ AperÃ§u des paris gÃ©nÃ©rÃ©s :"
              head -n 10 donnees/paris_du_jour.csv
            else
              echo "â„¹ï¸ Aucun pari UltraSafe trouvÃ© pour aujourd'hui"
            fi
          else
            echo "âŒ Le fichier 'paris_du_jour.csv' n'a pas Ã©tÃ© gÃ©nÃ©rÃ©."
            exit 1
          fi
          
          if [ -f "donnees/historique.csv" ]; then
            echo "âœ… Fichier 'historique.csv' mis Ã  jour."
            
            # Afficher les derniÃ¨res analyses ajoutÃ©es
            echo "ğŸ“‹ DerniÃ¨res analyses ajoutÃ©es Ã  l'historique :"
            tail -n 5 donnees/historique.csv
          fi

          # Afficher des statistiques sur le fichier de matchs utilisÃ©
          if [ -f "donnees/matchs_du_jour.json" ]; then
            match_count=$(python3 -c "
import json
try:
    with open('donnees/matchs_du_jour.json', 'r') as f:
        data = json.load(f)
    count = data.get('count', len(data.get('fixtures', data.get('matchs', []))))
    source = data.get('source', 'inconnu')
    print(f'Matchs analysÃ©s: {count}, Source: {source}')
except Exception as e:
    print(f'Erreur lecture matchs: {e}')
")
            echo "ğŸ“Š $match_count"
          fi

      - name: 6. Sauvegarder les rÃ©sultats dans le repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ° Paris UltraSafe du $(date -u +%Y-%m-%d) - Source: ${{ env.MATCHS_SOURCE_FINAL }}"
          file_pattern: "donnees/paris_du_jour.csv donnees/historique.csv"
          commit_user_name: "GitHub Action UltraSafe"
          commit_user_email: "action@github.com"
          commit_author: "GitHub Action UltraSafe <action@github.com>"

      - name: 7. CrÃ©er un artefact avec les rÃ©sultats
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Paris-du-jour-${{ github.run_number }}
          path: |
            donnees/paris_du_jour.csv
            donnees/historique.csv
            donnees/matchs_du_jour.json
          retention-days: 7
