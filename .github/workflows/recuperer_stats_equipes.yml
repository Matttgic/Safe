name: RÃ©cupÃ©rer Stats Ã‰quipes UltraSafe

on:
  workflow_dispatch:
    inputs:
      league_id:
        description: "ID Ligue spÃ©cifique (optionnel, ex: 39 pour Premier League)"
        required: false
        type: string
      limit:
        description: "Nombre max d'Ã©quipes Ã  traiter (test)"
        required: false
        default: ""
        type: string
      pause:
        description: "Pause entre requÃªtes API (secondes)"
        required: false
        default: "2.0"
        type: string
  push:
    paths:
      - donnees/team_ids.json

jobs:
  stats:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 heures max (Ã©tait 60)
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Installer dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: VÃ©rifier team_ids.json
        run: |
          if [ ! -f donnees/team_ids.json ]; then
            echo "âŒ Fichier donnees/team_ids.json manquant"
            echo "ğŸ’¡ ExÃ©cutez d'abord le workflow 'RÃ©cupÃ©rer Team IDs'"
            exit 1
          fi
          
          echo "âœ… team_ids.json trouvÃ©"
          echo "ğŸ“Š Taille: $(wc -c < donnees/team_ids.json) bytes"
          
          # Compter les Ã©quipes
          teams_count=$(python3 -c "
import json
with open('donnees/team_ids.json', 'r') as f:
    data = json.load(f)
total = sum(len(league.get('teams', [])) for league in data.get('leagues', []))
print(total)
")
          echo "âš½ Total Ã©quipes Ã  traiter: $teams_count"

      - name: Test API rapide
        env:
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
        run: |
          echo "ğŸ§ª Test endpoint /teams/statistics..."
          python3 -c "
import requests, os, sys
headers = {
    'X-RapidAPI-Key': os.getenv('RAPIDAPI_KEY'),
    'X-RapidAPI-Host': 'api-football-v1.p.rapidapi.com'
}
# Test avec Manchester City (team 50, Premier League)
try:
    resp = requests.get(
        'https://api-football-v1.p.rapidapi.com/v3/teams/statistics?league=39&season=2025&team=50',
        headers=headers,
        timeout=10
    )
    print(f'Status: {resp.status_code}')
    
    if resp.status_code == 200:
        data = resp.json()
        print(f'Results: {data.get(\"results\", 0)}')
        
        if data.get('response'):
            response_data = data['response']
            # Afficher la structure pour debug
            print(f'Response keys: {list(response_data.keys())}')
            
            # Tester goals
            goals = response_data.get('goals', {})
            if goals:
                print(f'Goals structure: {list(goals.keys())}')
                goals_for = goals.get('for', {})
                if goals_for and isinstance(goals_for, dict):
                    avg_data = goals_for.get('average', {})
                    if avg_data and isinstance(avg_data, dict):
                        avg_total = avg_data.get('total')
                        print(f'Goals for avg total: {avg_total}')
            
            # Tester possession
            possession = response_data.get('possession')
            print(f'Possession type/value: {type(possession)} = {possession}')
            
        else:
            print('No response data')
    else:
        print(f'Error {resp.status_code}: {resp.text[:300]}')
        
except Exception as e:
    print(f'Exception during API test: {e}')
    sys.exit(1)
"

      - name: RÃ©cupÃ©rer statistiques Ã©quipes
        env:
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
        run: |
          echo "ğŸš€ RÃ©cupÃ©ration des statistiques Ã©quipes..."
          
          # S'assurer que le script est exÃ©cutable
          chmod +x scripts/recuperer_stats_equipes.py
          
          # Construction des arguments
          args="--teams-file donnees/team_ids.json --output donnees/stats_equipes.jsonl"
          
          if [ -n "${{ github.event.inputs.league_id }}" ]; then
            args="$args --league ${{ github.event.inputs.league_id }}"
            echo "ğŸ¯ Ligue spÃ©cifique: ${{ github.event.inputs.league_id }}"
          fi
          
          if [ -n "${{ github.event.inputs.limit }}" ] && [ "${{ github.event.inputs.limit }}" != "" ]; then
            args="$args --limit ${{ github.event.inputs.limit }}"
            echo "âš¡ Limite: ${{ github.event.inputs.limit }} Ã©quipes"
          fi
          
          if [ -n "${{ github.event.inputs.pause }}" ]; then
            args="$args --pause ${{ github.event.inputs.pause }}"
            echo "â¸ï¸ Pause: ${{ github.event.inputs.pause }}s"
          fi
          
          # Ajouter debug pour les 3 premiÃ¨res Ã©quipes si limite activÃ©e
          if [ -n "${{ github.event.inputs.limit }}" ] && [ "${{ github.event.inputs.limit }}" != "" ]; then
            limit_val=${{ github.event.inputs.limit }}
            if [ "$limit_val" -le 5 ]; then
              args="$args --debug"
              echo "ğŸ” Mode debug activÃ© pour test"
            fi
          fi
          
          echo "ğŸ“‹ Commande: python3 scripts/recuperer_stats_equipes.py $args"
          
          # ExÃ©cuter le script
          python3 scripts/recuperer_stats_equipes.py $args

      - name: Analyser les rÃ©sultats
        run: |
          if [ -f donnees/stats_equipes.jsonl ]; then
            echo "âœ… Fichier stats_equipes.jsonl gÃ©nÃ©rÃ©"
            echo "ğŸ“Š Taille: $(wc -c < donnees/stats_equipes.jsonl) bytes"
            echo "ğŸ“„ Lignes: $(wc -l < donnees/stats_equipes.jsonl)"
            
            # Analyser le contenu JSONL avec plus de dÃ©tails
            python3 -c "
import json
import sys
from collections import Counter

total_teams = 0
with_stats = 0
without_stats = 0
leagues = set()
stats_counts = Counter()

try:
    with open('donnees/stats_equipes.jsonl', 'r') as f:
        for line_num, line in enumerate(f, 1):
            if line.strip():
                try:
                    record = json.loads(line)
                    total_teams += 1
                    leagues.add(record.get('league_id'))
                    
                    if record.get('raw_data_available', False):
                        with_stats += 1
                        # Compter les stats non-null
                        stats = record.get('stats', {})
                        non_null_stats = sum(1 for v in stats.values() if v is not None)
                        stats_counts[non_null_stats] += 1
                    else:
                        without_stats += 1
                        error = record.get('error', 'Unknown')
                        print(f'Team without stats: {record.get(\"team_name\")} - {error}')
                        
                except json.JSONDecodeError as e:
                    print(f'JSON error line {line_num}: {e}')

    print(f'\\nğŸ“ˆ ANALYSE DÃ‰TAILLÃ‰E:')
    print(f'ğŸ“Š Total Ã©quipes traitÃ©es: {total_teams}')
    print(f'âœ… Avec statistiques: {with_stats}')
    print(f'âŒ Sans statistiques: {without_stats}')
    print(f'ğŸ† Ligues couvertes: {sorted(list(leagues))}')
    
    if stats_counts:
        print(f'\\nğŸ“‹ Distribution des stats par Ã©quipe:')
        for count, teams in sorted(stats_counts.items(), reverse=True):
            print(f'  {count}/10 stats: {teams} Ã©quipes')
    
except Exception as e:
    print(f'âŒ Erreur analyse: {e}')
    import traceback
    traceback.print_exc()
    sys.exit(1)
"
            
            echo ""
            echo "ğŸ“‹ Ã‰chantillon de donnÃ©es (premiÃ¨res 2 lignes):"
            head -2 donnees/stats_equipes.jsonl | while read line; do
              echo "$line" | python3 -m json.tool 2>/dev/null || echo "$line"
            done
            
            # Afficher les fichiers debug si prÃ©sents
            if ls debug_raw_*.json 1> /dev/null 2>&1; then
              echo ""
              echo "ğŸ” Fichiers debug gÃ©nÃ©rÃ©s:"
              ls -la debug_raw_*.json
            fi
            
          else
            echo "âŒ Fichier stats_equipes.jsonl manquant"
            
            # VÃ©rifier si des fichiers intermÃ©diaires existent
            echo "ğŸ” Fichiers prÃ©sents dans le rÃ©pertoire:"
            ls -la donnees/ || true
            
            # VÃ©rifier les logs d'erreur
            echo "ğŸ“‹ Contenu stderr/stdout prÃ©cÃ©dent:"
            tail -50 /dev/null || true
            
            exit 1
          fi

      - name: Upload artifacts (toujours exÃ©cutÃ©)
        uses: actions/upload-artifact@v4
        if: always()  # Upload mÃªme en cas d'Ã©chec partiel
        with:
          name: stats_equipes_${{ github.run_number }}
          path: |
            donnees/stats_equipes.jsonl
            donnees/team_ids.json
            debug_raw_*.json
          retention-days: 7

      - name: Commit des rÃ©sultats
        if: success()  # Seulement si tout s'est bien passÃ©
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action UltraSafe"
          
          # VÃ©rifier s'il y a des changements
          if [ -f donnees/stats_equipes.jsonl ] && [ -n "$(git status --porcelain donnees/stats_equipes.jsonl)" ]; then
            git add donnees/stats_equipes.jsonl
            
            # Message de commit avec dÃ©tails
            teams_count=$(wc -l < donnees/stats_equipes.jsonl)
            timestamp=$(date -u +"%Y-%m-%d %H:%M UTC")
            
            if [ -n "${{ github.event.inputs.league_id }}" ]; then
              commit_msg="ğŸ“Š Stats Ã©quipes UltraSafe - Ligue ${{ github.event.inputs.league_id }} ($teams_count Ã©quipes) - $timestamp"
            else
              commit_msg="ğŸ“Š Stats Ã©quipes UltraSafe - Toutes ligues ($teams_count Ã©quipes) - $timestamp"
            fi
            
            git commit -m "$commit_msg"
            git push
            echo "âœ… Statistiques commitÃ©es: $commit_msg"
          else
            echo "â„¹ï¸ Aucun changement dans stats_equipes.jsonl Ã  committer"
          fi
          
          # Nettoyer les fichiers debug temporaires
          rm -f debug_raw_*.json || true
